<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BikeSafe TO</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.1.0/dist/geosearch.css"/>
<style>
  body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
  #map { height:100%; width:100%; }
  .popup-buttons, .popup-edit { display:flex; flex-direction:column; gap:10px; text-align:center; }
  .hazard-btn, .popup-edit button { 
    padding:10px 20px; font-size:22px; font-weight:bold; cursor:pointer; border:none; border-radius:5px; color:white; 
  }
  .Construction { background-color: orange; }
  .PoorRoad { background-color: red; }
  .Debris { background-color: yellow; color:black; }
  .legend { background:white; padding:16px; line-height:1.8; border-radius:7px; box-shadow:0 0 5px rgba(0,0,0,0.3); font-size:16px; min-width:180px; }
  .legend span { display:inline-block; width:12px; height:12px; margin-right:5px; vertical-align:middle; }
  .legend h4 { margin:0 0 7px 0; font-size:16px; }
  #notification { position:fixed; top:10px; left:50%; transform:translateX(-50%); padding:10px 20px; border-radius:5px; display:none; font-weight:bold; z-index:1000; box-shadow:0 0 5px rgba(0,0,0,0.3); }
  .popup-edit button:nth-child(1) { background-color: #007bff; }
  .popup-edit button:nth-child(2) { background-color: #dc3545; }
</style>
</head>
<body>

<div id="notification"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geosearch@3.1.0/dist/bundle.min.js"></script>

<script>
const SHEETDB_URL = 'https://sheetdb.io/api/v1/k1z7j20dp9lms';
const HAZARD_LIFETIME_DAYS = 7;
let nextId = 1;
const markers = {};
let tempMarker = null;

// ------------------
// Initialize map
const map = L.map('map').setView([43.65107, -79.347015], 12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

// ------------------
// Utility functions
function getBikeLaneColor(type){
  if(!type) return "gray";
  type = type.toLowerCase();
  if(type.includes("signed route") || type.includes("sharrow")) return "#007bff";
  if(type.includes("bike lane") || type.includes("contraflow")) return "#28a745";
  if(type.includes("multi-use trail") || type.includes("cycle track") || type.includes("park road")) return "#6f42c1";
  return "gray";
}

function getColor(type){
  switch(type){
    case "Construction": return "orange";
    case "Poor Road Condition": return "red";
    case "Debris": return "yellow";
    default: return "blue";
  }
}

function timeAgo(isoDate){
  const now = new Date(), report = new Date(isoDate);
  const diff = Math.floor((now - report)/1000);
  if(diff < 60) return `${diff} seconds ago`;
  if(diff < 3600) return `${Math.floor(diff/60)} minutes ago`;
  if(diff < 86400) return `${Math.floor(diff/3600)} hours ago`;
  return `${Math.floor(diff/86400)} days ago`;
}

function showNotification(type){
  const notif = document.getElementById('notification');
  const emoji = type==="Construction"? "🚧" : type==="Poor Road Condition"? "🛑" : "⚠️";
  notif.textContent = `${emoji} ${type} reported!`;
  notif.style.background = getColor(type);
  notif.style.color = (type==="Debris") ? "black" : "white";
  notif.style.display = 'block';
  setTimeout(()=>{ notif.style.display='none'; }, 5000);
}

// ------------------
// Marker functions
function generatePopupContent(id,type,timestamp){
  return `<b>Hazard:</b> ${type}<br><b>Reported:</b> ${timeAgo(timestamp)}<br>
    <div class="popup-edit">
      <button class="edit-btn" data-id="${id}">Edit</button>
      <button class="delete-btn" data-id="${id}">Delete</button>
    </div>`;
}

function createMarker(id, latlng, type, timestamp){
  const marker = L.circleMarker(latlng, { color:getColor(type), radius:16, fillOpacity:0.7 }).addTo(map);
  marker.bindPopup(generatePopupContent(id,type,timestamp));

  marker.on('popupopen', function(){
    const popupEl = marker.getPopup().getElement();
    if(!popupEl) return;

    // Edit button
    popupEl.querySelectorAll('.edit-btn').forEach(btn=>{
      btn.addEventListener('click', e=>{
        e.stopPropagation();
        const hazard = markers[id];
        if(!hazard) return;
        const editPopup = `
          <div class="popup-buttons">
            <b>Edit Hazard</b>
            <button class="hazard-btn" data-type="Construction" style="background: orange;">Construction</button>
            <button class="hazard-btn" data-type="Poor Road Condition" style="background: red;">Poor Road Condition</button>
            <button class="hazard-btn" data-type="Debris" style="background: yellow; color:black;">Debris</button>
          </div>`;
        marker.setPopupContent(editPopup).openPopup();

        const editEl = marker.getPopup().getElement();
        editEl.querySelectorAll('.hazard-btn').forEach(hBtn=>{
          hBtn.addEventListener('click', evt=>{
            evt.stopPropagation();
            const newType = hBtn.getAttribute('data-type');
            hazard.type = newType;
            marker.setStyle({ color:getColor(newType) });
            marker.setPopupContent(generatePopupContent(id,newType,hazard.timestamp)).openPopup();

            // Update SheetDB
            fetch(`${SHEETDB_URL}/id/${id}`, {
              method:'PATCH',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ data:[{ Type: newType }] })
            });
          });
        });
      });
    });

    // Delete button
    popupEl.querySelectorAll('.delete-btn').forEach(btn=>{
      btn.addEventListener('click', e=>{
        e.stopPropagation();
        map.removeLayer(marker);
        delete markers[id];
        fetch(`${SHEETDB_URL}/id/${id}`, { method:'DELETE' });
      });
    });
  });

  markers[id] = { marker, type, timestamp };
}

// ------------------
// Load bike lanes
fetch('toronto_bike_lanes.geojson')
  .then(res=>res.json())
  .then(geojson=>{
    L.geoJSON(geojson, {
      style: f=>({ color:getBikeLaneColor(f.properties.INFRA_HIGHORDER||f.properties.INFRA_LOWORDER), weight:4, opacity:0.8 }),
      onEachFeature: (f,l)=>l.bindPopup(`<b>${f.properties.STREET_NAME||'Bike Lane'}</b><br>${f.properties.INFRA_HIGHORDER||f.properties.INFRA_LOWORDER}`)
    }).addTo(map);
  });

// ------------------
// Load existing hazards
fetch(SHEETDB_URL).then(res=>res.json()).then(data=>{
  if(data.length>0){
    nextId = Math.max(...data.map(i=>parseInt(i.id)))+1;
  }
  data.forEach(item=>{
    if(item.Lat && item.Lng && item.Type && item.Timestamp && item.id){
      const ageDays = (new Date() - new Date(item.Timestamp))/(1000*60*60*24);
      if(ageDays <= HAZARD_LIFETIME_DAYS){
        createMarker(item.id, L.latLng(parseFloat(item.Lat), parseFloat(item.Lng)), item.Type, item.Timestamp);
      }
    }
  });
});

// ------------------
map.on('click', function(e){
  // Remove previous temp marker
  if(tempMarker){
    map.removeLayer(tempMarker);
  }

  // Create temp marker
  tempMarker = L.marker(e.latlng).addTo(map);

  // Initial popup content
  const initialPopup = `
    <div class="popup-buttons">
      <b>Location:</b><br>
      Lat: ${e.latlng.lat.toFixed(5)}, Lng: ${e.latlng.lng.toFixed(5)}<br><br>
      <button class="report-btn" style="padding:10px 20px; font-size:18px; background:#007bff; color:white; border:none; border-radius:5px; cursor:pointer;">Report Hazard</button>
    </div>
  `;
  tempMarker.bindPopup(initialPopup).openPopup();

  // Small delay to ensure popup DOM exists
  setTimeout(() => {
    const popupEl = tempMarker.getPopup().getElement();
    if(!popupEl) return;

    const reportBtn = popupEl.querySelector('.report-btn');
    if(reportBtn){
      reportBtn.onclick = function(evt){
        evt.stopPropagation();

        // Show hazard type buttons
        const hazardPopup = `
          <div class="popup-buttons">
            <button class="hazard-btn" data-type="Construction" style="background: orange;">Construction</button>
            <button class="hazard-btn" data-type="Poor Road Condition" style="background: red;">Poor Road Condition</button>
            <button class="hazard-btn" data-type="Debris" style="background: yellow; color:black;">Debris</button>
          </div>
        `;
        tempMarker.setPopupContent(hazardPopup).openPopup();

        const hazardPopupEl = tempMarker.getPopup().getElement();
        hazardPopupEl.querySelectorAll('.hazard-btn').forEach(btn=>{
          btn.onclick = function(evt){
            evt.stopPropagation();
            const type = btn.getAttribute('data-type');
            const id = nextId++;
            const timestamp = new Date().toISOString();

            map.removeLayer(tempMarker);
            tempMarker = null;

            createMarker(id, e.latlng, type, timestamp);
            showNotification(type);

            // Send data to SheetDB
            fetch(SHEETDB_URL, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ data:[{ id, Lat:e.latlng.lat, Lng:e.latlng.lng, Type:type, Timestamp:timestamp }] })
            });
          };
        });
      };
    }
  }, 20); // short delay ensures popup exists
});


// ------------------
// Legend
const legend = L.control({position:'topright'});
legend.onAdd = function(map){
  const div = L.DomUtil.create('div','legend');
  div.innerHTML = "<h4>Legend</h4>";
  div.innerHTML += "<b>Hazards</b><br>";
  div.innerHTML += '<span style="background: orange"></span> Construction<br>';
  div.innerHTML += '<span style="background: red"></span> Poor Road Condition<br>';
  div.innerHTML += '<span style="background: yellow"></span> Debris<br><br>';
  div.innerHTML += "<b>Bike Lanes</b><br>";
  div.innerHTML += '<span style="background:#007bff"></span> Signed Route / Sharrows<br>';
  div.innerHTML += '<span style="background:#28a745"></span> Bike Lane / Contraflow / Buffered<br>';
  div.innerHTML += '<span style="background:#6f42c1"></span> Multi-Use Trail / Cycle Track<br>';
  return div;
};
legend.addTo(map);

// ------------------
// Search control
const gtaViewbox = [-79.6393, 43.5810, -79.1169, 43.8555];
const provider = new window.GeoSearch.OpenStreetMapProvider({
  params:{ countrycodes:'ca', addressdetails:1, limit:5, viewbox:gtaViewbox.join(','), bounded:1 }
});
const searchControl = new window.GeoSearch.GeoSearchControl({
  provider: provider, style:'bar', showMarker:true, showPopup:true, autoComplete:true, autoClose:true, retainZoomLevel:false, searchLabel:'Search GTA address...'
});
map.addControl(searchControl);
</script>
</body>
</html>
